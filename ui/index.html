<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Piccolo</title>
	<meta name="application-name" content="Piccolo">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="/ui/icons.css">
	<style type="text/css">
		:root {
			--color-1: #222;
			--color-1-dark-1: #ffe8e6;
			--color-1-dark-2: #ffe8e6;

			--color-2: #1e90ff;
			--color-2-dark-1: #0483ff;
			--color-2-dark-2: #0077ea;

			--color-3: whitesmoke;
			--color-3-dark-1: #e8e8e8;
			--color-3-dark-2: #dcdcdc;
		}

		*,
		*::before,
		*::after {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		:root,
		html,
		body {
			width: 100%;
			height: 100%;
			background-color: var(--color-1);
			color: var(--color-3);
			font: 400 normal 16px/1.2 Lato, 'Helvetica Neue', Arial, Helvetica, sans-serif;
			-ms-text-size-adjust: 100%;
			-webkit-text-size-adjust: 100%;
			-moz-text-size-adjust: auto;
			-moz-text-size-adjust: 100%;
		}

		:disabled {
			cursor: default;
			opacity: 0.45;
			pointer-events: none;
		}

		[hidden] {
			display: none !important;
		}

		.h1,
		.h2,
		.h3,
		.h4,
		.h5,
		.h6 {
			margin: 1.2rem 0 0.6rem 0;
			font-weight: bold;
		}

		.h1:first-child,
		.h2:first-child,
		.h3:first-child,
		.h4:first-child,
		.h5:first-child,
		.h6:first-child {
			margin-top: 0;
		}

		.h1 {
			font-size: 2rem;
		}
		.h2 {
			font-size: 1.71rem;
		}
		.h3 {
			font-size: 1.28rem;
		}
		.h4 {
			font-size: 1.07rem;
		}
		.h5 {
			font-size: 1rem;
		}
		.h6 {
			font-size: 0.8rem;
		}

		.p {
			display: block;
			margin: 0.6rem 0;
		}

		.button {
			will-change: '';
			cursor: pointer;
			position: relative;
			min-height: 1rem;
			display: inline-block;
			margin: 0 0.25rem 0 0;
			padding: 0.78571429rem 1.5rem 0.78571429rem;
			background-color: var(--color-2);
			vertical-align: baseline;
			font: inherit;
			font-weight: bold;
			text-align: center;
			text-overflow: ellipsis;
			text-transform: uppercase;
			color: var(--color-3);
			user-select: none;
			outline: 0;
			border: none;
			border-radius: 0.28571429rem;
			transition:
				opacity 0.1s ease,
				background-color 0.1s ease,
				color 0.1s ease,
				background 0.1s ease;
		}

		.button::-moz-focus-inner {
			border: none;
		}

		.button:hover,
		.button:focus {
			background-color: var(--color-2-dark-1);
			color: var(--color-3-dark-1);
		}

		.button:active {
			background-color: var(--color-2-dark-2);
			color: var(--color-3-dark-2);
		}

		.button:not(.button-icon) > i:first-child {
			margin-right: 0.6rem;
		}

		.button.button-frameless {
			background-color: transparent;
			text-transform: none;
			color: var(--color-3-dark-2); /* rgba(255, 255, 255, 0.5) */
		}

		.button.button-frameless:hover,
		.button.button-frameless:focus {
			color: var(--color-2-dark-1);
		}

		.button.button-frameless:active {
			color: var(--color-2-dark-2);
		}

		.button.button-frameless.button-frameless-active {
			color: var(--color-3);
		}

		.button.button-danger {
			background-color: #de6262;
			color: #f5f5f5;
		}

		.button.button-danger:hover,
		.button.button-danger:focus {
			background-color: #da4d4d;
			color: #e8e8e8;
		}

		.button.button-danger:active {
			background-color: #d53838;
			color: #dcdcdc;
		}

		.button.button-floating {
			position: absolute;
			bottom: 1rem;
			right: 1rem;
			box-shadow:
				0 2px 2px 0 rgba(0, 0, 0, 0.14),
				0 1px 5px 0 rgba(0, 0, 0, 0.12),
				0 3px 1px -2px rgba(0, 0, 0, 0.2);
		}

		.link {
			cursor: pointer;
			text-decoration: none;
			color: var(--color-3);
		}

		.link:hover {
			color: var(--color-2-dark-1);
		}

		.link:focus {
			outline: 0;
			/*border: 1px solid var(--color-primary);*/
			box-shadow:
				0 0 0 0.2rem var(--color-2-dark-1),
				0 0 0 0.4rem var(--color-2-dark-1);
		}

		.link:active {
			color: #0077ea;
		}

		.input {
			position: relative;
			padding: 0.67857143rem 1rem;
			background-color: #404040;
			font: inherit;
			color: whitesmoke;
			border: 1px solid #595959;
			/*border-radius: 0.28571429rem;*/
			outline: 0;
			transition: border-color 0.1s ease;
		}

		.input:focus {
			border-color: var(--color-2);
			outline: 0;
		}

		.input:invalid {
			border-color: #de6262;
			box-shadow: none;
		}

		.input[type="color"] {
			min-height: 2.68125rem;
		}

		.select {
			position: relative;
			cursor: pointer;
			padding: 0.67857143rem 1rem;
			background-color: #404040;
			font: inherit;
			text-transform: none;
			text-overflow: ellipsis;
			color: whitesmoke;
			border: 1px solid #595959;
			/*border-radius: 0.28571429rem;*/
			outline: 0;
			transition: border-color 0.1s ease;

			-moz-appearance: none;
			-webkit-appearance: none;
			appearance: none;
			background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23f5f5f5%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
			background-repeat: no-repeat, repeat;
			background-position: right 0.7rem top 50%, 0 0;
			background-size: 0.65rem auto, 100%;
		}

		.select:-moz-focusring {
			color: transparent;
			text-shadow: 0 0 0 #000;
		}

		.select:focus {
			border-color: var(--color-2);
			outline: 0;
		}

		.select optgroup {
			background-color: var(--color-2);
			font-weight: bold;
			color: var(--color-3);
		}

		.select option {
			cursor: pointer;
			background-color: var(--color-1);
			color: var(--color-3);
		}

		.select option:hover:not(:disabled) {
			color: inherit;
		}

		.select option:disabled {
			cursor: default;
			color: rgb(109, 109, 109);
		}

		.list {
			display: block;
			width: 100%;
		}

		.list > li {
			display: block;
			position: relative;
			padding: 0.5rem 1rem;
			width: 100%;
			overflow: hidden;
		}

		.list > li > i:first-child {
			margin-right: 1rem;
			vertical-align: middle;
		}

		.list.list-divided > li:not(:last-of-type) {
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.list.list-bordered > li {
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		.list.list-bordered > li:not(:first-child) {
			border-top: none;
		}

		.list.list-striped > li:nth-child(even) {
			background-color: rgba(255, 255, 255, 0.05);
		}

		.list.list-hover > li:hover {
			cursor: pointer;
			background-color: var(--color-3);
			color: var(--color-1);
		}

		.error-message {
			position: fixed;
			bottom: 0;
			left: 50%;
			transform: translateX(-50%);
			width: 50%;
			min-width: 320px;
			max-width: 100%;
			z-index: 200;
			padding: 0.78571429rem 1.5rem 0.78571429rem;
			background-color: #de6262;
			color: #ffe8e6;
		}

		.splash {
			position: fixed;
			width: 100%;
			height: 100%;
			background-color: var(--color-1);
			z-index: 100;
		}

		#splash-loading {
			display: flex;
			flex-flow: row nowrap;
			justify-content: center;
			align-items: center;
			align-content: center;
		}

		#splash-password {
			display: flex;
			flex-flow: row nowrap;
			justify-content: center;
			align-items: center;
			align-content: center;
		}

		#piccolo-password {
			width: 90%;
			max-width: 800px;
		}

		.header {
			display: flex;
			flex-flow: row nowrap;
			justify-content: flex-start;
			align-items: center;
			align-content: center;
		}

		.header-logo {
			flex: 1;
			margin-left: 1rem;
		}

		.main {

		}

		.page {

		}

		.splash-pic-toolbar {
			position: fixed;
			width: 100%;
			top: 0;
			left: 0;
			z-index: 101;
			display: flex;
			flex-flow: row nowrap;
			justify-content: flex-start;
			align-items: center;
			align-content: center;
			background-color: rgba(0, 0, 0, 0.5);
		}

		.splash-pic-dialog {
			position: fixed;
			width: 32rem;
			bottom: 0;
			left: 50%;
			transform: translateX(-50%);
			max-width: 90%;
			max-height: 90%;
			z-index: 101;
			display: flex;
			flex-flow: column nowrap;
			justify-content: flex-start;
			align-items: stretch;
			align-content: stretch;
			padding: 1rem;
			background-color: var(--color-1);
		}

		.favorite-active {
			color: gold !important;
		}

		.pic-preview-container {
			display: flex;
			flex-flow: row wrap;
			justify-content: flex-start;
			align-items: flex-start;
			align-content: flex-start;
		}

		.pic-preview {
			position: relative;
			width: 150px;
			height: 150px;
			background: #404040;
			margin: 1px;
			cursor: pointer;
			overflow: hidden;
		}

		@media (min-width: 320px) and (max-width: 480px) {
			.pic-preview {
				width: 100px;
				height: 100px;
			}
		}

		.pic-preview.pic-preview-selected {
			border: 2px solid dodgerblue;
		}

		.pic-preview > img,
		.pic-preview > canvas,
		.pic-preview > video,
		.splash > img,
		.splash > canvas,
		.splash > video {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			max-width: 100%;
			max-height: 100%;
		}

		.pic-preview-tip {
			position: absolute;
			bottom: 5%;
			right: 5%;
			font-size: 0.5rem;
			z-index: 1;
		}

		#main-page-tags-filter {
			display: block;
			width: 90%;
			max-width: 800px;
			margin: 0 auto;
		}

		#main-page-tags-list {
			display: block;
			width: 90%;
			max-width: 800px;
			margin: 0 auto;
		}
	</style>
</head>
<body>
	<input id="upload-input" type="file" hidden>

	<div id="splash-loading" class="splash">
		<p>Loading...</p>
	</div>

	<div id="splash-password" hidden class="splash">
		<input id="piccolo-password" type="password" class="input">
	</div>

	<div id="splash-pic" hidden class="splash"></div>

	<div class="header">
		<div class="header-logo"><span style="color: orange">Pic</span><span style="color: dodgerblue">colo</span></div>
		<button data-action="tags" title="Tags" class="button button-icon button-frameless"><i class="icon-search"></i></button>
		<button data-action="random" title="Random" class="button button-icon button-frameless"><i class="icon-shuffle"></i></button>
		<button data-action="upload" title="Upload" class="button button-icon button-frameless"><i class="icon-folder-upload"></i></button>
		<button data-action="rehash" title="Rehash" class="button button-icon button-frameless"><i class="icon-database"></i></button>
	</div>
	<div class="main">
		<div id="main-page-pics" hidden class="page pic-preview-container"></div>
		<div id="main-page-tags" hidden class="page">
			<input id="main-page-tags-filter" type="search" class="input">
			<ul id="main-page-tags-list" class="list list-hover"></ul>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
	<script type="text/javascript">
		fetch('/api/auth', { method: 'GET' }).then(function (response) {
			if (!response.ok) {
				if (response.status === 401) {
					$('#splash-loading').prop('hidden', true);
					$('#splash-password').prop('hidden', false);
				} else {
					const error = `HTTP Error ${response.status}: ${response.statusText}`;
					throw new Error(error);
				}
			} else {
				$('#splash-loading').prop('hidden', true);
			}
		}).catch(function (error) {
			console.error(error);
			error_message(error.message);
		});

		$('#piccolo-password').on('keydown', function(e) {
			if (e.which === 10 || e.which === 13) {
				let password = $('#piccolo-password').val();
				let authorization = `Basic ${btoa(`piccolo:${password}`)}`;
				fetch('/api/auth', {
					method: 'GET',
					headers: { 'Authorization': authorization },
				}).then(function (response) {
					if (!response.ok) {
						if (response.status === 401) {
							$('#piccolo-password').val('');
						}
						const error = `HTTP Error ${response.status}: ${response.statusText}`;
						throw new Error(error);
					} else {
						window.authorization = authorization;
						$('#piccolo-password').val('');
						$('#splash-password').prop('hidden', true);
					}
				}).catch(function (error) {
					console.error(error);
					error_message(error.message);
				});
			}
		});

		$('#main-page-tags-filter').on('input', function() {
			let $filter = $(this),
				pattern = $filter.val().toLowerCase().replace('_', ' '),
				$list = $('#main-page-tags-list');
			if (pattern === '') {
				$list.find('li').prop('hidden', false);
			} else {
				$list.find('li').each(function () {
					let $li = $(this),
						tag = $li.data('tag');
					if (tag.label.toLowerCase().replace('_', ' ').indexOf(pattern) !== -1) {
						$li.prop('hidden', false);
					} else {
						$li.prop('hidden', true);
					}
				});
			}
		});

		var observer = new IntersectionObserver(function (entries, self) {
			entries.forEach(function (entry) {
				if (entry.isIntersecting) {
					//console.log('Pic ' + entry.target + ' is in the viewport!');
					setTimeout(function () {
						if (entry.isIntersecting) {
							// load image
							let $item = $(entry.target),
								pic = $item.data('pic'),
								thumbnail = new Image();
							thumbnail.onload = function () {
								$item.append(thumbnail);
							};
							thumbnail.onerror = function () {
								let element;
								if (['.gif'].includes(pic.ext)) {
									element = document.createElement('canvas');
									var context = element.getContext('2d'),
										img = new Image();
									img.onload = function () {
										element.height = 100;
										element.width = element.height * img.naturalWidth / img.naturalHeight;
										context.drawImage(img, 0, 0, element.width, element.height);
										$item.attr('title', get_pic_tooltip(pic, img.naturalWidth, img.naturalHeight));
									};
									img.src = `/api/pic/${pic.id}/raw`;
								} else if (['.webm', '.flv', '.mp4', '.mpg', '.mpeg', '.mov', '.avi', '.heic'].includes(pic.ext)) {
									element = document.createElement('video');
									element.autoplay = false;
									element.controls = false;
									element.loop = true;
									element.muted = true;
									element.addEventListener('mouseover', function () {
										element.play();
									});
									element.addEventListener('mouseout', function () {
										element.pause();
									});
									element.addEventListener('loadedmetadata', function () {
										$item.attr('title', get_pic_tooltip(pic, element.videoWidth, element.videoHeight));
									});
									element.src = `/api/pic/${pic.id}/raw`;
								} else {
									element = new Image();
									element.onload = function () {
										$item.attr('title', get_pic_tooltip(pic, element.naturalWidth, element.naturalHeight));
									};
									element.src = `/api/pic/${pic.id}/raw`;
								}
								$item.append(element);
							};
							thumbnail.src = `/api/pic/${pic.id}/thumb`;
							// Stop watching and load the image
							self.unobserve(entry.target);
						}
					}, 1000);
				}
			});
		}, {
			rootMargin: '100px 0px 100px 0px',
			threshold: 1
		});

		var humanize_size = function (bytes, decimals = 2) {
			if (bytes === 0) {
				return '0 byte';
			}
			const k = 1024;
			const dm = decimals < 0 ? 0 : decimals;
			const sizes = ['byte', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
		};

		var humanize_time = function (milliseconds) {
			function number_ending(number) {
				return (number > 1) ? 's' : '';
			}
			let temp = Math.floor(milliseconds / 1000),
				years = Math.floor(temp / 31536000);
			if (years) {
				return years + ' year' + number_ending(years);
			}
			//TODO: Months! Maybe weeks? 
			let days = Math.floor((temp %= 31536000) / 86400);
			if (days) {
				return days + ' day' + number_ending(days);
			}
			let hours = Math.floor((temp %= 86400) / 3600);
			if (hours) {
				return hours + ' hour' + number_ending(hours);
			}
			let minutes = Math.floor((temp %= 3600) / 60);
			if (minutes) {
				return minutes + ' minute' + number_ending(minutes);
			}
			let seconds = temp % 60;
			if (seconds) {
				return seconds + ' second' + number_ending(seconds);
			}
			return 'less than a second'; // 'just now' or other string you like
		};

		var error_message = function (message) {
			const $item = $('<div class="error-message"></div>').text(message || 'Error');
			$('body').append($item);
			setTimeout(function () {
				$item.remove();
			}, 4000);
		};

		var get_pic_tooltip = function (pic, width, height) {
			let array = [];
			array.push(`Type: ${pic.ext.substring(1).toUpperCase()}`);
			if (pic.size) {
				array.push(`Size: ${pic.size} byte (${humanize_size(pic.size)})`);
			}
			if (width && height) {
				array.push(`Size: ${width}×${height}`);
			}
			array.push(`Tags: ${pic.tags.join(' ')}`);
			return array.join('\n');
		};

		var random_pic = function () {
			fetch('/api/pic/random', {
				method: 'GET',
				headers: window.authorization ? { 'Authorization': window.authorization } : undefined
			}).then(function (response) {
				if (!response.ok) {
					const error = `HTTP Error ${response.status}: ${response.statusText}`;
					throw new Error(error);
				}
				return response.json();
			}).then(function (data) {
				render_pic(data, true);
			}).catch(function (error) {
				console.error(error);
				error_message(error.message);
			});
		};

		var render_pic = function (pic, random_mode) {
			//console.log(pic);
			let $splash_pic = $('#splash-pic');
			$splash_pic.empty();
			$splash_pic.prop('hidden', false);
			$splash_pic.data('pic', pic);
			$splash_pic.data('random_mode', random_mode || false);
			let element
			if (['.webm', '.flv', '.mp4', '.mpg', '.mpeg', '.mov', '.avi', '.heic'].includes(pic.ext)) {
				element = document.createElement('video');
				element.autoplay = true;
				element.controls = true;
				element.loop = true;
				element.muted = false;
				element.addEventListener('loadedmetadata', function () {
					element.setAttribute('title', get_pic_tooltip(pic, element.videoWidth, element.videoHeight));
				});
				element.src = `/api/pic/${pic.id}/raw`;
				$splash_pic.append(element);
			} else {
				element = new Image();
				element.onload = function () {
					element.setAttribute('title', get_pic_tooltip(pic, element.naturalWidth, element.naturalHeight));
				};
				element.src = `/api/pic/${pic.id}/raw`;
			}
			$splash_pic.append(element);
			$splash_pic.append(
				'<div class="splash-pic-toolbar">' +
					'<button data-action="pic-close" title="Close" class="button button-icon button-frameless"><i class="icon-cross"></i></button>' +
					'<div style="flex: 1">&nbsp;</div>' +
					'<button data-action="pic-remove" title="Close" class="button button-icon button-frameless"><i class="icon-bin2"></i></button>' +
					'<button data-action="pic-edit" title="Tags" class="button button-icon button-frameless"><i class="icon-price-tags"></i></button>' +
					`<button data-action="pic-favorite" title="Close" class="button button-icon button-frameless${pic.tags.includes('favorite') ? ' favorite-active' : ''}"><i class="icon-star-full"></i></button>` +
				'</div>');
		};

		var delete_pic = function (pic) {
			if (confirm('Are you sure to delete this image?')) {
				fetch(`/api/pic/${pic.id}`, {
					method: 'DELETE',
					headers: window.authorization ? { 'Authorization': window.authorization } : undefined
				}).then(function (response) {
					if (!response.ok) {
						const error = `HTTP Error ${response.status}: ${response.statusText}`;
						throw new Error(error);
					}
					let $splash_pic = $('#splash-pic');
					if ($splash_pic.data('random_mode')) {
						random_pic();
					} else {
						$(`[data-pic="${pic.id}"]`).remove();
						const current_pic = $splash_pic.data('pic');
						const pics_list = $('#main-page-pics').data('pics');
						if (current_pic && pics_list) {
							let next_pic;
							for (let i = 0; i < pics_list.length; ++i) {
								if (pics_list[i].id === current_pic.id) {
									if (pics_list[i + 1]) {
										next_pic = pics_list[i + 1];
									}
									pics_list.splice(i, 1);
									break;
								}
							}
							if (next_pic) {
								render_pic(next_pic);
							} else {
								$splash_pic.prop('hidden', true);
								$splash_pic.empty();
							}
						}
					}
				}).catch(function (error) {
					console.error(error);
					error_message(error.message);
				});
			}
		};

		/*
		var upload_file = function (file) {
			let reader = new FileReader();
			reader.onabort = function (event) {
				open_dialog({ title: 'Error', content: 'Request Failed.' });
			};
			reader.onerror = function (event) {
				open_dialog({ title: 'Error', content: 'Request Failed.' });
			};
			reader.onload = function (event) {
				let formdata = new FormData();
				formdata.append('file', new Blob([event.target.result], { type: 'application/octet-binary' }), file.name);
				$.ajax({
					type: 'POST',
					url: '/pics/upload',
					data: formdata,
					cache: false,
					contentType: false,
					processData: false,
					dataType: 'json'
				}).fail(function () {
					open_dialog({ title: 'Error', content: 'Request Failed.' });
				}).done(function (data) {
					if (data.status !== 'ok') {
						open_dialog({ title: 'Error', content: `status = ${data.status}, error = ${data.error}` });
					}
				});
			};
			reader.readAsArrayBuffer(file);
		};
		*/

		/*
		var render_tags_list = function (mode) {
			let tags = $('#datalist-tags').data('tags');
			if (!mode) {
				mode = $('#tags-sorting').val();
			}
			if (mode === 'alpha') {
				tags.sort(function (a, b) {
					return a.label.toLowerCase() < b.label.toLowerCase() ? -1 : 1;
				});
			} else if (mode === 'alpha-desc') {
				tags.sort(function (a, b) {
					return a.label.toLowerCase() > b.label.toLowerCase() ? -1 : 1;
				});
			} else if (mode === 'count') {
				tags.sort(function (a, b) {
					return a.count < b.count ? -1 : 1;
				});
			} else if (mode === 'count-desc') {
				tags.sort(function (a, b) {
					return a.count > b.count ? -1 : 1;
				});
			}
			var $list = $('#tags-list').empty();
			tags.forEach(function (tag) {
				var $li = $(`<li data-tag="${tag.label}" class="tags-list-item">${tag.label} (${tag.count})</li>`);
				$list.append($li);
			});
			var pattern = $('#tags-search').val();
			filter_tags_list(pattern);
		};
		*/

		$('body').on('click', '[data-action]', function () {
			let $this = $(this),
				action = $this.attr('data-action');
			if (action === 'random') {

				random_pic();

			} else if (action === 'upload') {

				alert('TODO');

			} else if (action === 'tags') {

				$('.page').prop('hidden', true);
				let $page_tags = $('#main-page-tags'),
					$list = $('#main-page-tags-list').empty();
				fetch('/api/tag', {
					method: 'GET',
					headers: window.authorization ? { 'Authorization': window.authorization } : undefined
				}).then(function (response) {
					if (!response.ok) {
						const error = `HTTP Error ${response.status}: ${response.statusText}`;
						throw new Error(error);
					}
					return response.json();
				}).then(function (data) {
					data.tags.sort(function (a, b) {
						return a.count > b.count ? -1 : 1;
					}).forEach(function (tag) {
						let $item = $(`<li data-action="tag" data-tag="${tag.label}">${tag.label} (${tag.count})</li>`);
						$item.data('tag', tag);
						$list.append($item);
					});
					$('#main-page-tags-filter').trigger('input');
					$page_tags.prop('hidden', false);
				}).catch(function (error) {
					console.error(error);
					error_message(error.message);
				});

			} else if (action === 'tag') {

				$('.page').prop('hidden', true);
				const $page_pics = $('#main-page-pics');
				const tag_label = $this.attr('data-tag');
				$page_pics.empty();
				fetch(`/api/tag/${tag_label}`, {
					method: 'GET',
					headers: window.authorization ? { 'Authorization': window.authorization } : undefined
				}).then(function (response) {
					if (!response.ok) {
						const error = `HTTP Error ${response.status}: ${response.statusText}`;
						throw new Error(error);
					}
					return response.json();
				}).then(function (data) {
					data.pics.sort(function (a, b) {
						if (a.birthtime > b.birthtime) {
							return -1;
						} else if (a.birthtime < b.birthtime) {
							return 1;
						} else if (a.mtime > b.mtime) {
							return -1;
						} else if (a.mtime < b.mtime) {
							return 1;
						} else {
							return 0;
						}
					}).forEach(function (pic) {
						const $item = $(`<div data-action="pic" data-pic="${pic.id}" title="${get_pic_tooltip(pic)}" class="pic-preview"><div class="pic-preview-tip">${pic.ext.substring(1)}</div></div>`);
						$item.data('pic', pic);
						observer.observe($item[0]);
						$page_pics.append($item);
					});
					$page_pics.data('pics', data.pics);
					$page_pics.prop('hidden', false);
				}).catch(function (error) {
					console.error(error);
					error_message(error.message);
				});

			} else if (action === 'pic') {

				const pic = $this.data('pic');
				render_pic(pic);

			} else if (action === 'rehash') {

				if (confirm('Are you sure to start database refactoring?')) {
					const $splash_loading = $('#splash-loading');
					$splash_loading.prop('hidden', false);
					fetch(`/api/rehash`, {
						method: 'POST',
						headers: window.authorization ? { 'Authorization': window.authorization } : undefined
					}).then(function (response) {
						if (!response.ok) {
							const error = `HTTP Error ${response.status}: ${response.statusText}`;
							throw new Error(error);
						}
						$splash_loading.prop('hidden', true);
					}).catch(function (error) {
						console.error(error);
						error_message(error.message);
					});
				}

			} else if (action === 'pic-close') {

				const $splash_pic = $('#splash-pic');
				$splash_pic.prop('hidden', true);
				$splash_pic.empty();

			} else if (action === 'pic-remove') {

				const $splash_pic = $('#splash-pic');
				const pic = $splash_pic.data('pic');
				delete_pic(pic);

			} else if (action === 'pic-favorite') {

				const $splash_pic = $('#splash-pic');
				const pic = $splash_pic.data('pic');
				if ($this.hasClass('favorite-active')) {
					pic.tags.splice(pic.tags.indexOf('favorite'), 1);
				} else {
					pic.tags.push('favorite');
				}
				fetch(`/api/pic/${pic.id}`, {
					method: 'POST',
					headers: window.authorization ? { 'Authorization': window.authorization } : undefined,
					body: JSON.stringify({ tags: pic.tags })
				}).then(function (response) {
					if (!response.ok) {
						const error = `HTTP Error ${response.status}: ${response.statusText}`;
						throw new Error(error);
					} else {
						render_pic(pic, $splash_pic.data('random_mode'));
					}
				}).catch(function (error) {
					console.error(error);
					error_message(error.message);
				});

			} else if (action === 'pic-edit') {

				const $splash_pic = $('#splash-pic');
				const $dialog = $splash_pic.find('.splash-pic-dialog');
				if ($dialog.length > 0) {
					$dialog.remove()
				} else {
					const pic = $splash_pic.data('pic');
					const $dialog = $(
						'<div class="splash-pic-dialog"><textarea rows="10" class="input"></textarea></div>');
					$dialog.find('textarea').val(pic.tags.join('\r\n')).on('change', function () {
						pic.tags = [];
						$(this).val().split(/\r\n|\r|\n/).forEach(function (row) {
							const tag = row.trim()
								.replace(' ', '_')
								.replace('è', 'e')
								.replace('é', 'e')
								.replace('à', 'a')
								.replace('ù', 'u')
								.replace('ò', 'o')
								.replace('ì', 'i');
							if (tag !== '') {
								pic.tags.push(tag);
							}
						});
						fetch(`/api/pic/${pic.id}`, {
							method: 'POST',
							headers: window.authorization ? { 'Authorization': window.authorization } : undefined,
							body: JSON.stringify({ tags: pic.tags })
						}).then(function (response) {
							if (!response.ok) {
								const error = `HTTP Error ${response.status}: ${response.statusText}`;
								throw new Error(error);
							} else {
								render_pic(pic, $splash_pic.data('random_mode'));
							}
						}).catch(function (error) {
							console.error(error);
							error_message(error.message);
						});
					});
					$splash_pic.append($dialog);
				}

			}
		});

		var get_previous_pic = function (pic) {
			const pics_list = $('#main-page-pics').data('pics');
			if (pic && pics_list) {
				for (let i = 0; i < pics_list.length; ++i) {
					if (pics_list[i].id === pic.id) {
						if (pics_list[i - 1]) {
							return pics_list[i - 1];
						}
						break;
					}
				}
			}
			return null;
		};

		var get_next_pic = function (pic) {
			const pics_list = $('#main-page-pics').data('pics');
			if (pic && pics_list) {
				for (let i = 0; i < pics_list.length; ++i) {
					if (pics_list[i].id === pic.id) {
						if (pics_list[i + 1]) {
							return pics_list[i + 1];
						}
					}
				}
			}
			return null;
		};

		document.addEventListener('keyup', function (event) {
			if ($(event.target).hasClass('input')) {
				return;
			}
			const $splash_pic = $('#splash-pic');
			if ($splash_pic.prop('hidden')) {
				return;
			}
			if (event.key === 'ArrowLeft') {

				if (!$splash_pic.data('random_mode')) {
					const previous_pic = get_previous_pic($splash_pic.data('pic'));
					if (previous_pic) {
						render_pic(previous_pic);
					}
				}

			} else if (event.key === 'ArrowRight') {

				if ($splash_pic.data('random_mode')) {
					random_pic();
				} else {
					const next_pic = get_next_pic($splash_pic.data('pic'));
					if (next_pic) {
						render_pic(next_pic);
					}
				}

			} else if (event.key === 'Escape') {

				$splash_pic.prop('hidden', true);
				$splash_pic.empty();

			} else if (event.key === 'Backspace' || event.key === 'Delete')  {

				const pic = $splash_pic.data('pic');
				delete_pic(pic);

			} else {

				//console.log('keyup', event.key);

			}
		}, false);

		let SWIPE_START = null;
		$('#splash-pic').on('pointerdown', function (e) {
			if (e.originalEvent) {
				e = e.originalEvent;
			}
			if ($(event.target).hasClass('input')) {
				return;
			}
			SWIPE_START = e.pageX;
		}).on('pointermove', function (e) {
			if (e.originalEvent) {
				e = e.originalEvent;
			}
			if (SWIPE_START) {
				let direction = SWIPE_START > e.pageX ? 'left' : 'right',
					delta = Math.abs(SWIPE_START - e.pageX);
				if (direction === 'left' && delta > 100) {
					SWIPE_START = null;
					const $splash_pic = $('#splash-pic');
					if ($splash_pic.data('random_mode')) {
						random_pic();
					} else {
						const next_pic = get_next_pic($splash_pic.data('pic'));
						if (next_pic) {
							render_pic(next_pic);
						}
					}
				} else if (direction === 'right' && delta > 100) {
					SWIPE_START = null;
					const $splash_pic = $('#splash-pic');
					if (!$splash_pic.data('random_mode')) {
						const previous_pic = get_previous_pic($('#splash-pic').data('pic'));
						if (previous_pic) {
							render_pic(previous_pic);
						}
					}
				}
			}
		}).on('pointerup pointercancel', function (e) {
			SWIPE_START = null;
		});

		/*
		document.addEventListener('deviceready', function () {
			document.addEventListener('backbutton', function (e) {
				let $splash_pic = $('#splash-pic');
				$splash_pic.prop('hidden', true);
				$splash_pic.empty();
				e.preventDefault();
			}, false);
		}, false);
		window.addEventListener('hashchange', function() {
			let $splash_pic = $('#splash-pic');
			$splash_pic.prop('hidden', true);
			$splash_pic.empty();
		}, false);
		*/
	</script>
</body>
</html>
