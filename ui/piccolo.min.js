!function(){var e={loadMap:function(t){var n=new FileReader;n.onload=function(t){try{window.MAP=JSON.parse(t.target.result),e.updateTagList(),$("#header-filter, #header-showtags, #header-search").prop("disabled",!1),$("main").empty(),$("#main-start").hide(),$("#main-loaded").show()}catch(t){alert("Error while loading map file.")}},n.readAsText(t)},updateTagList:function(){if(window.MAP){var t=document.getElementById("header-tags");t.innerHTML="";var n=document.getElementById("dialog-tags-content");n.innerHTML="",Object.keys(MAP.tags).sort().forEach(function(a){var i=document.createElement("option");i.value=a.replace(/\_/g," "),t.appendChild(i);var o=document.createElement("div");o.classList.add("badge"),o.textContent=a.replace(/\_/g," ")+" ("+MAP.tags[a].length+")",o.onclick=function(){e.filterByTag(a)},n.appendChild(o)})}},filterByTag:function(t){if(window.MAP){$(".backdrop, .dialog, #main-loaded").hide(),$("#main-loading").show();var n=$("<main></main>"),a=MAP.tags[t];if(!a)return void console.error('Tag "'+t+'" not found!');a.sort(function(e,t){return MAP.pics[e].timestamp>MAP.pics[t].timestamp?-1:1}).forEach(function(t){var a=!0,i=MAP.pics[t],o=i.path.substring(i.path.lastIndexOf("/")+1,i.path.lastIndexOf(".")),c=$('<div class="item" title="'+o+'" data-pic="'+t+'"'+(a?" data-lazy":"")+"></div>");a||c.append(e.renderThumbnail(t)),n.append(c)}),$("#main-loading").hide(),$("main").replaceWith(n),e.processScroll(),e.applyEventListener()}},renderThumbnail:function(e){var t,n=150,a=MAP.pics[e],i=a.path.substring(a.path.lastIndexOf(".")+1);if(-1!==["gif"].indexOf(i)){t=document.createElement("canvas");var o=t.getContext("2d"),c=new Image;c.onload=function(){t.height=n,t.width=n*c.width/c.height,o.drawImage(c,0,0,t.width,t.height)},c.src=a.path}else-1!==["webm","flv","mp4","mpg","mpeg","mov","avi"].indexOf(i)?(t=document.createElement("video"),t.autoplay=!1,t.controls=!1,t.loop=!0,t.onmouseover=function(){t.play()},t.onmouseout=function(){t.pause()},t.src=a.path):(t=new Image,t.src=a.path);return t.height=n,t},applyEventListener:function(){$(".item","main").on("click",function(){var e=$(this),t=e.data("pic"),n=MAP.pics[t],a=n.path.substring(n.path.lastIndexOf(".")+1),i=n.path.substring(n.path.lastIndexOf("/")+1,n.path.lastIndexOf("."));if(-1!==["webm","flv","mp4","mpg","mpeg","mov","avi"].indexOf(a)){var o=document.createElement("video");o.autoplay=!0,o.controls=!0,o.loop=!0,o.addEventListener("loadedmetadata",function(){o.videoHeight>.9*window.innerHeight&&(o.style.maxHeight="100%"),$("#dialog-pic-content").html(o)}),o.setAttribute("title",i),o.src=n.path}else{var c=new Image;c.onload=function(){c.naturalHeight>.9*window.innerHeight&&(c.style.maxHeight="100%"),$("#dialog-pic-content").html(c)},c.setAttribute("title",i),c.src=n.path}$(".backdrop, #dialog-pic").show()})},isElementInViewport:function(e){var t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.top<=(window.innerHeight||document.documentElement.clientHeight)},processScroll:function(){[].forEach.call(document.querySelectorAll("[data-lazy]"),function(t){e.isElementInViewport(t)&&(t.removeAttribute("data-lazy"),$(t).append(e.renderThumbnail($(t).data("pic"))))})}};window.Piccolo=e}(),$("#header-search").on("change",function(){Piccolo.filterByTag($(this).val().replace(/\s/g,"_"))}),$("#header-showtags").on("click",function(){$(".backdrop, #dialog-tags").show()}),$("#dialog-tags-close").on("click",function(){$(".backdrop, #dialog-tags").hide()}),$("#header-load").on("click",function(){$("#header-load-file").click()}),$("#header-load-file").on("change",function(){var e=$(this).get(0).files[0];Piccolo.loadMap(e)}),$(".backdrop").on("click",function(){$(".backdrop, .dialog").hide()});var debounce=function(e,t,n){var a;return function(){var i=this,o=arguments,c=function(){a=null,n||e.apply(i,o)},l=n&&!a;clearTimeout(a),a=setTimeout(c,t),l&&e.apply(i,o)}},onwheel=debounce(function(){Piccolo.processScroll()},250);document.addEventListener("wheel",onwheel);