<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Piccolo</title>
	<style type="text/css">
		*, *::before, *::after {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}
		html,
		body {
			width: 100%;
			height: 100%;
			font: 400 normal 14px/1.2 sans-serif;
			color: whitesmoke;
		}
		:disabled {
			opacity: 0.7;
			pointer-events: none;
		}
		body {
			display: flex;
			flex-flow: column nowrap;
		}
		header {
			display: flex;
			flex-flow: row nowrap;
			align-items: center;
			height: 50px;
			padding: 0 1rem;
			background: #222;
			border-bottom: 2px solid dodgerblue;
			box-shadow: 0px 3px 5px 0px black;
			z-index: 100;
		}
		input {
			background: transparent;
			font: inherit;
			color: inherit;
			border: none;
			padding: 0.5rem 0;
			border-bottom: 1px solid rgba(245, 245, 245, 0.3);
		}
		input:focus {
			background: transparent;
			font: inherit;
			color: inherit;
			border: none;
			border-bottom: 1px solid rgba(245, 245, 245, 0.5);
		}
		button {
			background: none;
			font: inherit;
			color: dodgerblue;
			border: none;
			padding: 0.5rem 1rem;
			cursor: pointer;
		}
		button:hover,
		button:focus {
			background: rgba(255, 255, 255, 0.1);
		}
		button:active {
			background: whitesmoke;
		}
		a {
			color: dodgerblue;
			cursor: pointer;
		}
		.header-separator {
			height: 50%;
			margin: 0 1rem;
			border-left: 1px solid rgba(245, 245, 245, 0.3);
		}
		main {
			flex: 1;
			display: flex;
			flex-flow: row wrap;
			justify-content: flex-start;
			align-items: center;
			align-content: flex-start;
			overflow: auto;
			background: #222;
			padding: 0.5rem;
		}
		.item {
			margin: 0.5rem;
			cursor: pointer;
		}
		[data-src] {
			width: 150px;
			height: 150px;
			background: lightsteelblue;
		}
		.backdrop {
			z-index: 199;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(55, 61, 73, 0.8);
		}
		.dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			min-width: 300px;
			max-width: 100%;
			min-height: 200px;
			max-height: 100%;
			display: flex;
			flex-flow: column nowrap;
			background: #222;
			border-bottom: 2px solid dodgerblue;
			box-shadow: 0px 3px 5px 0px black;
			z-index: 200;
		}
		.dialog-nobg {
			background: none;
			border: none;
			box-shadow: none;
		}
		.dialog-header {
			min-height: 50px;
			text-align: center;
			padding: 1rem;
		}
		.dialog-content {
			flex: 1;
			padding: 1rem;
			overflow: auto;
		}
		.dialog-footer {
			min-height: 50px;
			text-align: right;
			padding: 1rem;
		}
	</style>
</head>
<body>
	<header>
		<datalist id="header-tags"></datalist>
		<input id="header-search" type="search" list="header-tags" placeholder="Tag..." disabled style="flex: 1; margin-right: 1rem">
		<button id="header-filter" disabled>Filter</button>
		<!--<div class="header-separator"></div>-->
		<button id="header-showtags" disabled>Tags</button>
		<!--<div class="header-separator"></div>-->
		<button id="header-sort" disabled>Sort</button>
		<!--<div class="header-separator"></div>-->
		<button id="header-load">Load</button>
		<input id="header-load-file" type="file" hidden>
	</header>
	<main>
		<p style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)">Start by <a onclick="$('#header-load-file').click()">loading a map</a>.</p>
	</main>

	<div class="backdrop" style="display: none"></div>

	<!--
	<div class="dialog" style="display: none">
		<div class="dialog-header">
			<h1>Dialog Header</h1>
		</div>
		<div class="dialog-content">
			<p>Dialog content</p>
		</div>
		<div class="dialog-footer">
			<button>Close</button>
		</div>
	</div>
	-->

	<div id="dialog-pic" class="dialog dialog-nobg" style="display: none">
		<div id="dialog-pic-content" class="dialog-content" style="text-align: center"></div>
	</div>

	<script src="https://cdn.jsdelivr.net/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		(function () {

			var Piccolo = {
				loadMap: function (file) {
					var reader = new FileReader();
					reader.onload = function (e) {
						try {
							window.MAP = JSON.parse(e.target.result);
							Piccolo.updateTagList();
							$('#header-filter, #header-showtags, header-search').prop('disabled', false);
						} catch (e) {
							alert('Error while loading map file.');
						}
					};
					reader.readAsText(file);
				},
				updateTagList: function () {
					if (!window.MAP) {
						return;
					}
					var datalist = document.getElementById('header-tags');
					datalist.innerHTML = '';
					Object.keys(MAP.tags).forEach(function (tag) {
						var option = document.createElement('option');
						option.value = tag;
						datalist.appendChild(option);
					});
				},
				isElementInViewport: function (element) {
					var rect = element.getBoundingClientRect()
					return (rect.top >= 0 && rect.left >= 0 && rect.top <= (window.innerHeight || document.documentElement.clientHeight));
				},
				processScroll: function () {
					[].forEach.call(document.querySelectorAll('[data-src]'), function (element) {
						if (Piccolo.isElementInViewport(element)) {
							element.onload = function () {
								element.removeAttribute('data-src');
							};
							element.setAttribute('src', element.getAttribute('data-src'));
						}
					});
				},
				filterByTag: function (tag) {
					if (!window.MAP) {
						return;
					}
					var $main = $('<main></main>'),// $('main').empty(),
						pics = MAP.tags[tag];
					if (!pics) {
						console.error('Tag "' + tag + '" not found!');
						return;
					}
					pics.sort(function (a, b) {
						return MAP.pics[a].timestamp > MAP.pics[b].timestamp ? -1 : 1;
					}).forEach(function (picID) {
						var ELEMENT_WIDTH = 150,
							ELEMENT_HEIGHT = 150,
							pic = MAP.pics[picID],
							ext = pic.path.substring(pic.path.lastIndexOf('.') + 1),
							element;
						if (['gif'].indexOf(ext) !== -1) {
							element = document.createElement('canvas');
							var context = element.getContext('2d'),
								img = new Image();
							img.onload = function () {
								element.height = ELEMENT_HEIGHT;
								element.width = ELEMENT_HEIGHT * img.width / img.height;
								context.drawImage(img, 0, 0, element.width, element.height);
							};
							img.src = pic.path;
						} else if (['webm', 'flv', 'mp4'].indexOf(ext) !== -1) {
							element = document.createElement('video');
							element.autoplay = false;
							element.controls = false;
							element.loop = true;
							element.onmouseover = function () {
								console.log(element);
								element.play();
							};
							element.onmouseout = function () {
								element.pause();
							};
							element.src = pic.path;
						} else {
							element = new Image();
							element.src = pic.path;
						}
						element.height = ELEMENT_HEIGHT;
						var $container = $('<div class="item" data-pic="' + picID + '" title="' + (pic.path.substring(pic.path.lastIndexOf('/') + 1, pic.path.lastIndexOf('.'))) + '"></div>');
						$container.append(element);
						$main.append($container);
					});
					$('main').replaceWith($main);
					$('#header-sort').prop('disabled', false);
					//Piccolo.processScroll();
					$('.item', 'main').on('click', function () {
						var $item = $(this),
							picID = $item.data('pic'),
							pic = MAP.pics[picID],
							ext = pic.path.substring(pic.path.lastIndexOf('.') + 1);
						if (['png', 'jpg', 'jpeg', 'gif'].indexOf(ext) !== -1) {
							$('#dialog-pic-content').html('<img src="' + pic.path + '" style="max-width: 100%; max-height: 100%">');
						} else if (['webm', 'flv', 'mp4'].indexOf(ext) !== -1) {
							$('#dialog-pic-content').html('<video src="' + pic.path + '" autoplay loop controls style="max-width: 100%; max-height: 100%"></video>');
						}
						$('#dialog-pic, .backdrop').show();
					});
				}
			};

			window.Piccolo = Piccolo;
		})();

		$('#header-filter').on('click', function () {
			Piccolo.filterByTag($('#header-search').val());
		});

		$('#header-showtags').on('click', function () {
			alert('TODO');
		});

		$('#header-sort').on('click', function () {
			alert('TODO');
		});

		$('#header-load').on('click', function () {
			$('#header-load-file').click();
		});

		$('#header-load-file').on('change', function () {
			var file = $(this).get(0).files[0];
			Piccolo.loadMap(file);
		});

		/*
		var dropbox = document.getElementById('dropbox');
		dropbox.addEventListener("dragenter", function (e) {
			e.stopPropagation();
			e.preventDefault();
		}, false);
		dropbox.addEventListener("dragover", function (e) {
			e.stopPropagation();
			e.preventDefault();
		}, false);
		dropbox.addEventListener("drop", function (e) {
			e.stopPropagation();
			e.preventDefault();
			var file = e.dataTransfer.files[0];
			Piccolo.loadMap(file);
		}, false);
		*/

		$('.backdrop').on('click', function () {
			$('.backdrop, .dialog').hide();
		});

		//window.addEventListener('scroll', Piccolo.processScroll);
	</script>
</body>
</html>
