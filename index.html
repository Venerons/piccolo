<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Piccolo</title>
	<meta name="application-name" content="Piccolo">
	<meta name="viewport" content="width=device-width">

	<link rel="stylesheet" href="icons.css">

	<style type="text/css">
		*, *::before, *::after {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}
		html,
		body {
			width: 100%;
			height: 100%;
			font: 400 normal 16px/1.2 'Open Sans', sans-serif;
			color: whitesmoke;
			background: #333;
		}
		:disabled {
			opacity: 0.5;
			pointer-events: none;
		}
		input[type=text],
		input[type=search] {
			padding: 0.5rem;
			font: inherit;
			color: black;
			background: whitesmoke;
			border: 1px solid dodgerblue;
		}
		input[type=search] {
			min-height: 3rem;
			font: inherit;
			color: whitesmoke;
			background: transparent;
			border: none;
		}
		input[type=checkbox] {
			cursor: pointer;
		}
		.button {
			min-width: 57px;
			min-height: 3rem;
			margin: 0.5rem;
			padding: 0.5rem 1rem;
			font: inherit;
			color: dodgerblue;
			background: transparent;
			cursor: pointer;
			border: none;
			border-radius: 4px;
		}
		.button:hover,
		.button:focus {
			color: whitesmoke;
			background: dodgerblue;
		}
		.button:active {
			color: dodgerblue;
			background: whitesmoke;
		}
		.button.button-active {
			border: 2px solid dodgerblue;
		}
		a {
			color: dodgerblue;
			cursor: pointer;
		}
		body {
			display: flex;
			flex-flow: column nowrap;
		}
		.flex-row{
			display: flex;
			flex-flow: row nowrap;
			justify-content: flex-start;
			align-items: center;
			align-content: center;
		}
		.header {
			display: flex;
			flex-flow: row nowrap;
			align-items: center;
			padding: 0 1rem;
			background: #222;
			border-bottom: 2px solid dodgerblue;
			box-shadow: 0px 3px 5px 0px black;
			z-index: 100;
		}
		/*
		.header-buttons {
			position: fixed;
			bottom: 0;
			left: 0;
		}
		*/
		.page {
			flex: 1;
		}
		.pics-container {
			display: flex;
			flex-flow: row wrap;
			align-content: flex-start;
			align-items: flex-start;
			justify-content: flex-start;
		}
		.pic {
			position: relative;
			width: 150px;
			height: 150px;
			background: #222;
			margin: 1px;
		}
		@media (min-width: 320px) and (max-width: 480px) {
			.pic {
				width: 100px;
				height: 100px;
			}
		}
		.pic.pic-selected {
			border: 2px solid dodgerblue;
		}
		.pic-content > img,
		.pic-content > canvas,
		.pic-content > video {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			max-width: 100%;
			max-height: 100%;
		}
		ul {
			padding: 1rem 2rem;
		}
		.preview {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 200;
			background: rgba(0, 0, 0, 0.9);
		}
		.preview-toolbar {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			z-index: 202;
			background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), transparent);
			display: flex;
			flex-flow: row nowrap;
			align-items: center;
		}
		.preview-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 201;
		}
		.preview-container > img,
		.preview-container > video {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			max-width: 100%;
			max-height: 100%;
		}
		.dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 500px;
			min-width: 280px;
			max-width: 95%;
			height: auto;
			max-height: 95%;
			display: flex;
			flex-flow: column nowrap;
			justify-content: flex-start;
			align-items: stretch;
			align-content: stretch;

			border: none;
			border-top: 1px solid rgba(255, 255, 255, 0.2);
			box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
			border-radius: 10px;
			color: whitesmoke;
			background: #333;
		}
		.dialog::backdrop {
			background: rgba(0, 0, 0, 0.4);
		}
		.dialog + .backdrop {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.4);
		}
		.dialog h3 {
			padding: 1rem;
			text-overflow: ellipsis;
			font-size: 1.2rem;
			text-align: center;
			color: whitesmoke;
		}
		.dialog .dialog-content {
			padding: 0 1rem 1.5rem;
			overflow: auto;
			font-size: 1rem;
			border-bottom: 1px solid rgba(0, 0, 0, 0.2);
		}
		.dialog .dialog-buttonbar {
			min-height: 3rem;
			display: flex;
			flex-flow: row nowrap;
			justify-content: flex-start;
			align-items: stretch;
			align-content: stretch;
		}
		.dialog .dialog-buttonbar > .button {
			box-shadow: none;
			flex: 1;
			border-top: 1px solid rgba(255, 255, 255, 0.2);
			margin: 0;
		}
		.dialog .dialog-buttonbar > .button:first-of-type:last-of-type {
			border-radius: 0 0 10px 10px;
		}
		.dialog .dialog-buttonbar > .button:first-of-type:not(:last-of-type) {
			border-right: 1px solid rgba(0, 0, 0, 0.2);
			border-radius: 0 0 0 10px;
		}
		.dialog .dialog-buttonbar > .button:not(:first-of-type):not(:last-of-type) {
			border-right: 1px solid rgba(0, 0, 0, 0.2);
			border-left: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 0;
		}
		.dialog .dialog-buttonbar > .button:not(:first-of-type):last-of-type {
			border-left: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 0 0 10px 0;
		}
	</style>
</head>
<body>
	<datalist id="datalist-tags"></datalist>

	<header class="header">
		<span style="font-weight: bold">
			<span style="color: orange">Pic</span><span style="color: dodgerblue">colo</span>
		</span>
		<input id="header-search" type="search" list="datalist-tags" placeholder="Tag..." style="flex: 1">
		<div class="header-buttons">
			<button data-action="tags" title="Tags" class="button"><i class="icon-tags"></i></button>
			<button data-action="random" title="Random" class="button"><i class="icon-random"></i></button>
			<button data-action="rehash" title="Rehash" class="button"><i class="icon-refresh"></i></button>
			<button data-action="edit" title="Edit" class="button"><i class="icon-edit"></i></button>
		</div>		
	</header>

	<div class="edit-toolbar" style="display: none">
		<button data-action="add" title="Tags" class="button"><i class="icon-tags"></i> Add</button>
		<button data-action="remove" title="Random" class="button"><i class="icon-tags"></i> Remove</button>
		<button data-action="delete" title="Upload" class="button"><i class="icon-delete"></i> Delete</button>
	</div>

	<div id="container-tags" class="page" style="display: none">
		<div class="flex-row">
			<span>Sorting</span>
			<select id="tags-sorting" style="margin: 1rem">
				<option value="alpha">Alphabetic Ascendant</option>
				<option value="alpha-desc">Alphabetic Descendant</option>
				<option value="count">Count Ascendant</option>
				<option value="count-desc">Count Descendant</option>
			</select>
		</div>
		<ul id="tags-list"></ul>
	</div>

	<div id="pics-container" class="page pics-container" style="display: none"></div>

	<div id="preview" class="preview" style="display: none">
		<div class="preview-toolbar">
			<button data-action="back" title="Back" class="button"><i class="icon-left"></i></button>
			<button data-action="star" title="Star" class="button"><i class="icon-star"></i></button>
			<button data-action="delete" title="Delete" class="button"><i class="icon-delete"></i></button>
			<div style="flex: 1"></div>
			<button data-action="edit" title="Edit" disabled class="button"><i class="icon-edit"></i></button>
		</div>
		<div class="preview-container"></div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
	<script src="dialog-polyfill.js"></script>
	<script type="text/javascript">

		var observer = new IntersectionObserver(function (entries, self) {
			entries.forEach(function (entry) {
				if (entry.isIntersecting) {
					//console.log('Pic ' + entry.target + ' is in the viewport!');
					// load image
					render_pic(entry.target);
					// Stop watching and load the image
					self.unobserve(entry.target);
				}
			});
		}, {
			rootMargin: '0px 0px 0px 0px',
			threshold: 1
		});

		var open_dialog = function (settings) {
			var dialogID = 'dialog-' + Date.now();
			var $dialog = $(
				'<dialog id="' + dialogID + '" class="dialog">' +
					(settings.title ? '<h3></h3>' : '') +
					(settings.content ? '<div class="dialog-content"></div>' : '') +
					'<div class="dialog-buttonbar"></div>' +
				'</dialog>');
			if (settings.width) {
				$dialog.width(settings.width);
			}
			if (settings.height) {
				$dialog.height(settings.height);
				$dialog.find('.dialog-content').css({ flex: 1 });
			}
			if (settings.title) {
				$dialog.find('h3').text(settings.title);
			}
			if (settings.content) {
				$dialog.find('.dialog-content').append(settings.content);
			}
			if (settings.buttons) {
				if (settings.buttons.length === 0) {
					$dialog.find('.dialog-content').css({ 'border-bottom': 'none' });
					$dialog.find('.dialog-buttonbar').remove();
				} else {
					settings.buttons.forEach(function (button, index) {
						var $button = $('<button class="button">' + button.label + '</button>');
						if (button.onclick) {
							$button.on('click', function (e) {
								button.onclick.call($dialog[0], e);
							});
						}
						$dialog.find('.dialog-buttonbar').append($button);
					});
				}
			} else {
				var $button = $('<button autofocus class="button">' + _('close') + '</button>');
				$button.on('click', function (e) {
					$dialog[0].close();
					$dialog.remove();
				});
				$dialog.find('.dialog-buttonbar').append($button);
			}
			$('body').append($dialog);
			var dialog = document.getElementById(dialogID);
			dialogPolyfill.registerDialog(dialog);
			dialog.addEventListener('close', function () {
				$dialog.remove();
			});
			dialog.showModal();
			return dialog;
		};

		var open_alert = function (title, message) {
			open_dialog({
				title: title,
				content: '<p style="text-align: center">' + message + '</p>',
				buttons: [
					{
						label: 'Close',
						onclick: function () {
							this.close();
						}
					}
				]
			});
		};

		var get_tags_list = function () {
			var $controls = $('#header-search, #header-tags, #header-random, #header-edit');
			$controls.prop('disabled', true);
			$.ajax({
				type: 'GET',
				url: '/api?action=list_tags',
				dataType: 'json'
			}).fail(function () {
				console.error('get_tags_list', 'fail');
				$controls.prop('disabled', false);
				open_alert('Error', 'Request Failed.');
			}).done(function (data) {
				$controls.prop('disabled', false);
				if (data.status !== 'ok') {
					console.error('get_tags_list', data.status, data.error);
					open_alert('Error', 'status = ' + data.status + ', error = ' + data.error);
				} else {
					var $datalist = $('#datalist-tags').empty().data('tags', data.tags);
					data.tags.forEach(function (tag) {
						$datalist.append('<option value="' + tag.label + '"></option>');
					});
					render_tags_list();
				}
			});
		};

		var render_tags_list = function (mode) {
			var tags = $('#datalist-tags').data('tags');
			if (!mode) {
				mode = $('#tags-sorting').val();
			}
			if (mode === 'alpha') {
				tags.sort(function (a, b) {
					return a.label < b.label ? -1 : 1;
				});
			} else if (mode === 'alpha-desc') {
				tags.sort(function (a, b) {
					return a.label > b.label ? -1 : 1;
				});
			} else if (mode === 'count') {
				tags.sort(function (a, b) {
					return a.count < b.count ? -1 : 1;
				});
			} else if (mode === 'count-desc') {
				tags.sort(function (a, b) {
					return a.count > b.count ? -1 : 1;
				});
			}
			var $list = $('#tags-list').empty();
			tags.forEach(function (tag) {
				var $li = $('<li><a>' + tag.label + ' (' + tag.count + ')</a></li>');
				$li.data('tag', tag.label);
				$list.append($li);
			});
		};

		var get_pics_list = function (tags) {
			var $controls = $('#header-search, #header-tags, #header-random, #header-edit');
			$controls.prop('disabled', true);
			$.ajax({
				type: 'GET',
				url: '/api?action=list_pics&tags=' + tags.join(','),
				dataType: 'json'
			}).fail(function () {
				console.error('get_pics_list', 'fail');
				$controls.prop('disabled', false);
				open_alert('Error', 'Request Failed.');
			}).done(function (data) {
				$controls.prop('disabled', false);
				if (data.status !== 'ok') {
					console.error('get_pics_list', data.status, data.error);
					open_alert('Error', 'status = ' + data.status + ', error = ' + data.error);
				} else {
					render_pics_list(data.pics);
				}
			});
		};

		var get_random_pics_list = function () {
			var $controls = $('#header-search, #header-tags, #header-random, #header-edit');
			$controls.prop('disabled', true);
			$.ajax({
				type: 'GET',
				url: '/api?action=random_pics',
				dataType: 'json'
			}).fail(function () {
				console.error('get_random_pics_list', 'fail');
				$controls.prop('disabled', false);
				open_alert('Error', 'Request Failed.');
			}).done(function (data) {
				$controls.prop('disabled', false);
				if (data.status !== 'ok') {
					console.error('get_random_pics_list', data.status, data.error);
					open_alert('Error', 'status = ' + data.status + ', error = ' + data.error);
				} else {
					render_pics_list(data.pics);
				}
			});
		};

		var render_pics_list = function (pics) {
			var $container = $('#pics-container').empty().data('pics', pics);
			pics.forEach(function (pic) {
				var $pic = $(
					'<div title="' + pic.tags.join(' ') + '" class="pic">' +
						'<div class="pic-content"></div>' +
						(pic.tags.indexOf('piccolostar') !== -1 ? '<i class="icon-tags" style="position: absolute; top: 0; left: 0; color: gold"></i>' : '') +
					'</div>');
				$pic.data('pic', pic);
				observer.observe($pic[0]);
				$container.append($pic);
			});
			$('.page').hide();
			$('#pics-container').show();
		};

		var render_pic = function (pic_element) {
			var $pic = $(pic_element),
				pic = $pic.data('pic'),
				element;
			if (['gif'].indexOf(pic.ext) !== -1) {
				element = document.createElement('canvas');
				var context = element.getContext('2d'),
					img = new Image();
				img.onload = function () {
					element.height = 100;
					element.width = element.height * img.naturalWidth / img.naturalHeight;
					context.drawImage(img, 0, 0, element.width, element.height);
					element.setAttribute('title', img.naturalWidth + 'x' + img.naturalHeight + ' ' + pic.tags.join(' '));
				};
				img.src = '/pic?path=' + encodeURIComponent(pic.path);
			} else if (['webm', 'flv', 'mp4', 'mpg', 'mpeg', 'mov', 'avi'].indexOf(pic.ext) !== -1) {
				element = document.createElement('video');
				element.autoplay = false;
				element.controls = false;
				element.loop = true;
				element.muted = true;
				element.addEventListener('mouseover', function () {
					element.play();
				});
				element.addEventListener('mouseout', function () {
					element.pause();
				});
				element.addEventListener('loadedmetadata', function () {
					element.setAttribute('title', element.videoWidth + 'x' + element.videoHeight + ' ' + pic.tags.join(' '));
				});
				element.src = '/pic?path=' + encodeURIComponent(pic.path);
			} else {
				element = new Image();
				element.setAttribute('loading', 'lazy');
				element.onload = function () {
					element.setAttribute('title', element.naturalWidth + 'x' + element.naturalHeight + ' ' + pic.tags.join(' '));
				};
				element.src = '/pic?path=' + encodeURIComponent(pic.path);
			}
			$pic.find('.pic-content').append(element);
		};

		var preview_open = function () {
			var $preview = $('#preview');
			if (!$preview.hasClass('preview-open')) {
				$preview.addClass('preview-open').show();
			}
		};

		var preview_close = function () {
			var $preview = $('#preview');
			if ($preview.hasClass('preview-open')) {
				$preview.find('.preview-container').empty();
				$preview.removeClass('preview-open').hide();
			}
		};

		var preview_render_pic = function (pic) {
			var $preview = $('#preview'),
				$preview_container = $preview.find('.preview-container').empty();
			$preview.data('pic', pic);
			var element;
			if (['webm', 'flv', 'mp4', 'mpg', 'mpeg', 'mov', 'avi'].indexOf(pic.ext) !== -1) {
				element = document.createElement('video');
				element.autoplay = true;
				element.controls = true;
				element.loop = true;
				element.muted = false;
				element.addEventListener('loadedmetadata', function () {
					element.setAttribute('title', element.videoWidth + 'x' + element.videoHeight + ' ' + pic.tags.join(' '));
					$preview_container.append(element);
				});
				element.src = '/pic?path=' + encodeURIComponent(pic.path);
			} else {
				element = new Image();
				element.onload = function () {
					element.setAttribute('title', element.naturalWidth + 'x' + element.naturalHeight + ' ' + pic.tags.join(' '));
					$preview_container.append(element);
				};
				element.src = '/pic?path=' + encodeURIComponent(pic.path);
			}
		};

		var executeRehash = function () {
			var $controls = $('#header-search, #header-tags, #header-random, #header-edit');
			$controls.prop('disabled', true);
			$.ajax({
				type: 'GET',
				url: '/api?action=rehash',
				dataType: 'json'
			}).fail(function () {
				console.error('executeRehash', 'fail');
				$controls.prop('disabled', false);
				open_alert('Error', 'Request Failed.');
			}).done(function (data) {
				$controls.prop('disabled', false);
				if (data.status !== 'ok') {
					console.error('executeRehash', data.status, data.error);
					open_alert('Error', 'status = ' + data.status + ', error = ' + data.error);
				} else {
					open_alert('Rehash Completed', 'Rehash has been completed successfully.');
				}
				get_tags_list();
			});
		};

		var addTags = function (pics, tags) {
			$.ajax({
				type: 'GET',
				url: '/api?action=tags&pics=' + encodeURIComponent(JSON.stringify(pics)) + '&add=' + encodeURIComponent(JSON.stringify(tags)),
				dataType: 'json'
			}).fail(function () {
				console.error('addTags', 'fail');
				open_alert('Error', 'Request Failed.');
			}).done(function (data) {
				if (data.status !== 'ok') {
					console.error('addTags', data.status, data.error);
					open_alert('Error', 'status = ' + data.status + ', error = ' + data.error);
				} else {
					open_alert('Tags Added', 'Tags has been added successfully.');
				}
				get_tags_list();
			});
		};

		var removeTags = function (pics, tags) {
			$.ajax({
				type: 'GET',
				url: '/api?action=tags&pics=' + encodeURIComponent(JSON.stringify(pics)) + '&remove=' + encodeURIComponent(JSON.stringify(tags)),
				dataType: 'json'
			}).fail(function () {
				console.error('removeTags', 'fail');
				open_alert('Error', 'Request Failed.');
			}).done(function (data) {
				if (data.status !== 'ok') {
					console.error('removeTags', data.status, data.error);
					open_alert('Error', 'status = ' + data.status + ', error = ' + data.error);
				} else {
					open_alert('Tags Removed', 'Tags has been removed successfully.');
				}
				get_tags_list();
			});
		};

		var deletePics = function (pics) {
			$.ajax({
				type: 'GET',
				url: '/api?action=delete_pics&pics=' + encodeURIComponent(JSON.stringify(pics)),
				dataType: 'json'
			}).fail(function () {
				console.error('deletePics', 'fail');
			}).done(function (data) {
				if (data.status !== 'ok') {
					console.error('deletePics', data.status, data.error);
				} else {
					open_alert('Pics Deleted', 'Pics has been deleted successfully.');
				}
				get_tags_list();
			});
		};

		$('#header-search').on('change', function () {
			var pattern = $(this).val().trim();
			if (pattern === '') {
				return;
			}
			var tags = pattern.split(',').map(function (tag) {
				return tag.trim();
			});
			if (tags.length !== 0) {
				get_pics_list(tags);
			}
		});

		$('.header-buttons').on('click', '[data-action]', function () {
			var action = $(this).data('action');
			if (action === 'tags') {
				$('.page').hide();
				$('#header-edit').removeClass('button-active');
				$('.edit-toolbar').hide();
				$('.pic-selected').removeClass('pic-selected');
				delete window.EDIT_MODE;
				$('#container-tags').show();
			} else if (action === 'random') {
				get_random_pics_list();
			} else if (action === 'rehash') {
				var r = confirm('Execute reshash?');
				if (r) {
					executeRehash();
				}
			} else if (action === 'edit') {
				var $this = $(this),
					$toolbar = $('.edit-toolbar');
				if ($this.hasClass('button-active')) {
					$this.removeClass('button-active');
					$toolbar.hide();
					$('.pic-selected').removeClass('pic-selected');
					delete window.EDIT_MODE;
				} else {
					$this.addClass('button-active');
					$toolbar.show();
					window.EDIT_MODE = true;
				}
			}
		});

		$('.edit-toolbar').on('click', '[data-action]', function () {
			var action = $(this).data('action');
			if (action === 'add') {
				var pics = [];
				$('.pic-selected').each(function () {
					var $pic = $(this),
						pic = $pic.data('pic');
					if (pic) {
						pics.push(pic.path);
					}
				});
				if (pics.length === 0) {
					return;
				}
				var $content = $('<input type="text" list="datalist-tags" placeholder="Tag_1,Tag_2" style="width: 100%">');
				open_dialog({
					title: 'Add Tags',
					content: $content,
					buttons: [
						{
							label: 'Cancel',
							onclick: function () {
								this.close();
							}
						},
						{
							label: 'Add',
							onclick: function () {
								var tags = $content.filter('input').val().split(',');
								addTags(pics, tags);
								this.close();
							}
						}
					]
				});
			} else if (action === 'remove') {
				var pics = [],
					tags = [];
				$('.pic-selected').each(function () {
					var $pic = $(this),
						pic = $pic.data('pic');
					if (pic) {
						pics.push(pic.path);
						pic.tags.forEach(function (tag) {
							if (tags.indexOf(tag) === -1) {
								tags.push(tag);
							}
						});
					}
				});
				if (pics.length === 0) {
					return;
				}
				var $content = $(
					'<datalist id="datalist-tags-remove"></datalist>' +
					'<input type="text" list="datalist-tags-remove" placeholder="Tag_1,Tag_2" style="width: 100%">');
				var $datalist = $content.filter('datalist');
				tags.forEach(function (tag) {
					$datalist.append('<option value="' + tag + '"></option>');
				});
				open_dialog({
					title: 'Remove Tags',
					content: $content,
					buttons: [
						{
							label: 'Cancel',
							onclick: function () {
								this.close();
							}
						},
						{
							label: 'Remove',
							onclick: function () {
								var tags = $content.filter('input').val().split(',');
								removeTags(pics, tags);
								this.close();
							}
						}
					]
				});
			} else if (action === 'delete') {
				var pics = [];
				$('.pic-selected').each(function () {
					var $pic = $(this),
						pic = $pic.data('pic');
					if (pic) {
						pics.push(pic.path);
					}
				});
				if (pics.length === 0) {
					return;
				}
				open_dialog({
					title: 'Delete Pics',
					content: 'Are you sure?',
					buttons: [
						{
							label: 'Cancel',
							onclick: function () {
								this.close();
							}
						},
						{
							label: 'Delete',
							onclick: function () {
								deletePics(pics);
								this.close();
							}
						}
					]
				});
			}
		});

		$('#tags-sorting').on('change', function () {
			var sorting = $(this).val();
			render_tags_list(sorting);
		});

		$('#tags-list').on('click', 'li', function () {
			var tag = $(this).data('tag');
			$('#header-search').val(tag).trigger('change');
		});

		$('#pics-container').on('click', '.pic', function () {
			var $pic = $(this);
			if (window.EDIT_MODE) {
				$pic.toggleClass('pic-selected');
			} else {
				var pic = $(this).data('pic');
				preview_render_pic(pic);
				preview_open();
			}
		});

		$('.preview-toolbar').on('click', '[data-action]', function () {
			var action = $(this).data('action');
			if (action === 'back') {
				preview_close();
			} else if (action === 'star') {
				var pic = $('#preview').data('pic');
				if (pic.tags.indexOf('piccolostar') === -1) {
					addTags([pic.path], ['piccolostar']);
				} else {
					removeTags([pic.path], ['piccolostar']);
				}
			} else if (action === 'delete') {
				var pic = $('#preview').data('pic');
				open_dialog({
					title: 'Delete Pic',
					content: 'Are you sure?',
					buttons: [
						{
							label: 'Cancel',
							onclick: function () {
								this.close();
							}
						},
						{
							label: 'Delete',
							onclick: function () {
								deletePics([pic.path]);
								this.close();
								preview_close();
							}
						}
					]
				});
			} else if (action === 'edit') {
				// TODO
			}
		});

		document.addEventListener('keyup', function (event) {
			var $preview = $('#preview');
			if (!$preview.hasClass('preview-open')) {
				return;
			}
			if (event.key === 'ArrowLeft') {
				var current_pic = $preview.data('pic'),
					pics_list = $('#pics-container').data('pics');
				if (current_pic && pics_list) {
					var previous_pic;
					for (var i = 0; i < pics_list.length; ++i) {
						if (pics_list[i].path === current_pic.path) {
							if (pics_list[i - 1]) {
								previous_pic = pics_list[i - 1];
							}
							break;
						}
					}
					if (previous_pic) {
						preview_render_pic(previous_pic);
					}
				}
			} else if (event.key === 'ArrowRight') {
				var current_pic = $preview.data('pic'),
					pics_list = $('#pics-container').data('pics');
				if (current_pic && pics_list) {
					var next_pic;
					for (var i = 0; i < pics_list.length; ++i) {
						if (pics_list[i].path === current_pic.path) {
							if (pics_list[i + 1]) {
								next_pic = pics_list[i + 1];
							}
							break;
						}
					}
					if (next_pic) {
						preview_render_pic(next_pic);
					}
				}
			} else if (event.key === 'Escape') {
				preview_close();
			}
		}, false);

		get_tags_list();
	</script>
</body>
</html>
